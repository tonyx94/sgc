
@model List<SGC.Data.Entities.Solicitud>
@{
    ViewData["Title"] = "Gestión de Solicitudes";
    string currentRole = ViewBag.CurrentRole;
    int currentUserId = ViewBag.CurrentUserId;
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-light mb-0">Solicitudes de Crédito</h2>
            <p class="text-muted small">Administración y seguimiento de gestiones</p>
        </div>
        @if (currentRole == "ServicioCliente" || currentRole == "Administrador" || true) 
        {
            <a asp-action="Crear" class="btn btn-dark btn-sm px-4 rounded-pill shadow-sm">
                <i class="bi bi-plus-lg me-1"></i> Nueva Solicitud
            </a>
        }
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                        <th class="ps-4 py-3 fw-semibold border-0"># Gestión</th>
                        <th class="py-3 fw-semibold border-0">Cliente</th>
                        <th class="py-3 fw-semibold border-0">Monto</th>
                        <th class="py-3 fw-semibold border-0">Estado</th>
                        <th class="py-3 fw-semibold border-0">Fecha</th>
                        <th class="pe-4 py-3 text-end fw-semibold border-0">Acciones</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="ps-4 fw-medium text-secondary">#@item.Id</td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-medium text-dark">@item.Cliente.Nombre @item.Cliente.Apellido</span>
                                    <span class="text-muted small" style="font-size: 0.75rem;">ID: @item.ClienteId</span>
                                </div>
                            </td>
                            <td class="fw-bold text-dark">@item.Monto.ToString("C")</td>
                            <td>
                                <span class="badge rounded-pill fw-normal px-3 py-2 @ObtenerClaseEstado(item.Estado)">
                                    @item.Estado
                                </span>
                            </td>
                            <td class="text-muted">@item.FechaCreacion.ToShortDateString()</td>
                            <td class="pe-4 text-end">
                                <button class="btn btn-outline-dark btn-sm rounded-pill px-3" 
                                        onclick="verDetalle(this)"
                                        data-id="@item.Id"
                                        data-cliente="@item.Cliente.Nombre @item.Cliente.Apellido"
                                        data-monto="@item.Monto.ToString("C")"
                                        data-estado="@item.Estado"
                                        data-comentarios="@item.Comentarios"
                                        data-documentos="@item.Documentos">
                                    Gestionar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <p class="text-muted mb-0">No se encontraron solicitudes.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Principal -->
<div class="modal fade" id="gestionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <div>
                    <h5 class="modal-title fw-bold">Gestión #<span id="modalSolicitudId"></span></h5>
                    <p class="text-muted small mb-0">Detalle completo de la solicitud</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-4">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded-3 h-100">
                            <h6 class="text-uppercase text-muted small fw-bold mb-3">Información General</h6>
                            
                            <div class="mb-2">
                                <label class="small text-muted d-block">Cliente</label>
                                <span id="modalCliente" class="fw-medium"></span>
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted d-block">Monto Solicitado</label>
                                <span id="modalMonto" class="fw-bold text-success"></span>
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted d-block">Estado Actual</label>
                                <span id="modalEstado" class="badge bg-secondary"></span>
                            </div>
                             <div class="mb-2">
                                <label class="small text-muted d-block">Comentarios Iniciales</label>
                                <p id="modalComentarios" class="small mb-0 text-break"></p>
                            </div>
                            <div class="mb-0">
                                <label class="small text-muted d-block">Documentos Adjuntos</label>
                                <span id="modalDocumentosLink" class="small text-primary"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Acciones de Gestión</h6>
                        <textarea id="accionComentario" class="form-control mb-3 bg-light border-0" placeholder="Escriba un comentario o justificación para la acción..." rows="3" style="resize: none;"></textarea>
                        
                        <!-- Botones Dinámicos -->
                        <div id="botonesAnalista" class="d-none d-grid gap-2">
                            <div class="mb-2">
                                <label class="form-label small text-muted">Adjuntar Documentos Adicionales</label>
                                <input type="text" id="analistaDoc" class="form-control form-control-sm" placeholder="Nombre del documento...">
                            </div>
                            <button class="btn btn-primary rounded-pill py-2" onclick="procesarAccion('EnviadoAprobacion', 'Enviada Aprobacion')">
                                <i class="bi bi-send me-2"></i>Enviar a Aprobación
                            </button>
                        </div>

                        <div id="botonesGestor" class="d-none d-grid gap-2">
                            <button class="btn btn-success rounded-pill py-2" onclick="procesarAccion('Aprobado', 'Aprobada')">
                                <i class="bi bi-check-lg me-2"></i>Aprobar Solicitud
                            </button>
                            <button class="btn btn-warning text-white rounded-pill py-2" onclick="procesarAccion('Devolucion', 'Devolucion')">
                                <i class="bi bi-arrow-return-left me-2"></i>Devolver Solicitud
                            </button>
                        </div>
                         <div id="mensajeSinAcciones" class="text-center text-muted small d-none py-3">
                             <i class="bi bi-info-circle me-1"></i> No hay acciones disponibles para este estado/rol.
                        </div>
                    </div>
                </div>
                
                <h6 class="text-uppercase text-muted small fw-bold mt-4 mb-3">Bitácora de Movimientos</h6>
                <div id="bitacoraContainer" class="bg-light rounded-3 p-3 overflow-auto" style="max-height: 200px;">

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var currentRole = '@currentRole';
        var currentSolicitudId = 0;

        function verDetalle(button) {
  
            var id = button.getAttribute('data-id');
            var cliente = button.getAttribute('data-cliente');
            var monto = button.getAttribute('data-monto');
            var estado = button.getAttribute('data-estado');
            var comentarios = button.getAttribute('data-comentarios');
            var documentos = button.getAttribute('data-documentos');

            currentSolicitudId = id;
            
            document.getElementById('modalSolicitudId').textContent = id;
            document.getElementById('modalCliente').textContent = cliente;
            document.getElementById('modalMonto').textContent = monto;
            document.getElementById('modalEstado').textContent = estado;

            var badge = document.getElementById('modalEstado');
            badge.className = 'badge ' + ObtenerClaseEstadoJS(estado);

            document.getElementById('modalComentarios').textContent = commentsFallback(comentarios);
            
            var docsContainer = document.getElementById('modalDocumentosLink');
            if(documentos && documentos.length > 5) {
                 docsContainer.innerHTML = `<a href="${documentos}" target="_blank" class="text-decoration-none"><i class="bi bi-file-earmark-text me-1"></i>Ver Documento</a>`;
            } else {
                 docsContainer.textContent = 'Sin documentos adjuntos.';
            }
            document.getElementById('botonesAnalista').classList.add('d-none');
            document.getElementById('botonesGestor').classList.add('d-none');
            document.getElementById('mensajeSinAcciones').classList.add('d-none');
            var actionsVisible = false;

            if (currentRole === 'Analista' && (estado === 'Ingresado' || estado === 'Devolucion' || estado === 'Registrado')) {
                document.getElementById('botonesAnalista').classList.remove('d-none');
                actionsVisible = true;
            } else if (currentRole === 'Gestor' && estado === 'EnviadoAprobacion') {
                document.getElementById('botonesGestor').classList.remove('d-none');
                actionsVisible = true;
            } else if (currentRole === 'Administrador') {
                 
                 document.getElementById('botonesAnalista').classList.remove('d-none');
                 document.getElementById('botonesGestor').classList.remove('d-none');
                 actionsVisible = true;
            }
            
            if(!actionsVisible) {
                document.getElementById('mensajeSinAcciones').classList.remove('d-none');
            }


            var modal = new bootstrap.Modal(document.getElementById('gestionModal'));
            modal.show();


            document.getElementById('bitacoraContainer').innerHTML = `
                <div class="d-flex justify-content-center p-3">
                    <div class="spinner-border text-secondary spinner-border-sm" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>`;
            
            fetch('@Url.Action("GetBitacora", "Solicitud")?id=' + id)
                 .then(response => response.json())
                 .then(data => {
                     var container = document.getElementById('bitacoraContainer');
                     container.innerHTML = '';
                     if(data.success && data.data.length > 0) {
                         var html = '<ul class="list-unstyled mb-0">';
                         data.data.forEach(item => {
                             html += `
                                <li class="mb-3 border-bottom pb-2 last-border-0">
                                    <div class="d-flex justify-content-between">
                                        <small class="fw-bold text-dark">${item.accion}</small>
                                        <small class="text-muted">${item.fecha}</small>
                                    </div>
                                    <small class="d-block text-secondary mb-1">${item.usuario}</small>
                                    <p class="small text-muted mb-0 fst-italic">"${item.comentario}"</p>
                                </li>
                             `;
                         });
                         html += '</ul>';
                         container.innerHTML = html;
                     } else {
                         container.innerHTML = '<p class="text-muted small text-center mb-0">No hay registros de actividad.</p>';
                     }
                 });
        }

        function commentsFallback(val) {
             return (val && val !== 'null') ? val : 'Sin comentarios.';
        }

        function ObtenerClaseEstadoJS(estado) {
            switch(estado) {
                case "Registrado": return "bg-secondary";
                case "Ingresado": return "bg-primary";
                case "EnviadoAprobacion": return "bg-info text-dark";
                case "Aprobado": return "bg-success";
                case "Devolucion": return "bg-warning text-dark";
                default: return "bg-light text-dark border";
            }
        }

        async function procesarAccion(nuevoEstado, accionNombre) {
            var comentario = document.getElementById('accionComentario').value;
            if (!comentario && accionNombre === 'Devolucion') {
                Swal.fire({
                    title: 'Comentario Requerido',
                    text: 'Debe ingresar un comentario justificando la devolución.',
                    icon: 'warning',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            var data = {
                id: currentSolicitudId,
                nuevoEstado: nuevoEstado,
                comentario: comentario,
                accion: accionNombre
            };

            var resp = await fetch('@Url.Action("ActualizarEstado", "Solicitud")', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/x-www-form-urlencoded'}, 
                 body: new URLSearchParams(data)
            });
            
            var result = await resp.json();
            if(result.success) {
                 Swal.fire({
                     title: '¡Acción Exitosa!',
                     text: 'El estado de la solicitud ha sido actualizado.',
                     icon: 'success',
                     timer: 1500,
                     showConfirmButton: false
                 }).then(() => location.reload());
            } else {
                 Swal.fire('Error', result.message, 'error');
            }
        }
    </script>
}

@functions {
    string ObtenerClaseEstado(string estado) {
        return estado switch {
            "Registrado" => "bg-secondary",
            "Ingresado" => "bg-primary",
            "EnviadoAprobacion" => "bg-info",
            "Aprobado" => "bg-success",
            "Devolucion" => "bg-warning",
            _ => "bg-secondary"
        };
    }
}
